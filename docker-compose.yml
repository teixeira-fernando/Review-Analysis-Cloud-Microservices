version: '3'

services:
  localstack: # LocalStack container
    image: localstack/localstack:4.0.3
    ports:
      # Now only required if you need to access LocalStack from the host
      - "127.0.0.1:4566:4566"
      # Now only required if you need to access LocalStack from the host
      - "127.0.0.1:4510-4559:4510-4559"
    volumes:
      - ./localstack-setup.sh:/etc/localstack/init/ready.d/script.sh
    networks:
      ls:
        # Set the container IP address in the 10.0.2.0/24 subnet
        ipv4_address: 10.0.2.20


  review-collector:
    build:
      context: ./review-collector
      dockerfile: Dockerfile
    container_name: review-collector
    environment:
      AWS_ENDPOINT: http://localstack:4566
    depends_on:
      - localstack
    ports:
      - "8080:8080"
    dns:
      # Set the DNS server to be the LocalStack container
      - 10.0.2.20
    networks:
      - ls

  review-analyzer:
    build:
      context: ./review-analyzer
      dockerfile: Dockerfile
    container_name: review-analyzer
    environment:
      AWS_ENDPOINT: http://localstack:4566
    depends_on:
      - localstack
    ports:
      - "8081:8081"
    dns:
      # Set the DNS server to be the LocalStack container
      - 10.0.2.20
    networks:
      - ls

  e2e-tests:
    build:
      context: .
      dockerfile: e2e-tests/Dockerfile
    environment:
      - REVIEW_COLLECTOR_BASE_URL=review-collector
      - REVIEW_ANALYZER_BASE_URL=review-analyzer
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - review-collector
      - review-analyzer
    dns:
      # Set the DNS server to be the LocalStack container
      - 10.0.2.20
    networks:
      - ls
    entrypoint: [ "sh", "-c", "while ! nc -z review-collector 8080; do sleep 1; done; while ! nc -z review-analyzer 8081; do sleep 1; done; ./gradlew :e2e-tests:test" ]

networks:
  ls:
    ipam:
      config:
        # Specify the subnet range for IP address allocation
        - subnet: 10.0.2.0/24