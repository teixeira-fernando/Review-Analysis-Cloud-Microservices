version: '3'

services:
  localstack: # LocalStack container
    image: localstack/localstack:stable
    ports:
      # Now only required if you need to access LocalStack from the host
      - "127.0.0.1:4566:4566"
      # Now only required if you need to access LocalStack from the host
      - "127.0.0.1:4510-4559:4510-4559"
    environment:
        # LocalStack configuration: https://docs.localstack.cloud/references/configuration/
      - DEBUG=1
      #- SERVICES=s3,sqs
      - LS_LOG=debug
      #- SERVICES=s3:4566,sqs
      #- HOSTNAME=localstack
      #- HOSTNAME_EXTERNAL=localstack
    volumes:
      # Here you mount your setup file so it will be executed
      # when the container starts
      - ./localstack-setup.sh:/etc/localstack/init/ready.d/script.sh
      #- ./localstack-setup.sh:/docker-entrypoint-initaws.d/localstack-setup.sh
    # entrypoint: /bin/sh -c "echo 'AAAAAAAAAAAAAAAAAAA'; /docker-entrypoint-initaws.d/localstack-setup.sh"
    networks:
      ls:
        # Set the container IP address in the 10.0.2.0/24 subnet
        ipv4_address: 10.0.2.20


  review-collector:
    build:
      context: ./review-collector
      dockerfile: Dockerfile
    container_name: review-collector
    environment:
      # Set an env var to use later in the code
      AWS_ENDPOINT: http://localstack:4566
      S3_ENDPOINT: http://localhost.localstack.cloud:4566
    depends_on:
      - localstack
    ports:
      - "8080:8080"
    dns:
      # Set the DNS server to be the LocalStack container
      - 10.0.2.20
    networks:
      - ls

  review-analyzer:
    build:
      context: ./review-analyzer
      dockerfile: Dockerfile
    container_name: review-analyzer
    environment:
      # Set an env var to use later in the code
      AWS_ENDPOINT: http://localstack:4566
      S3_ENDPOINT: http://localhost.localstack.cloud:4566
    depends_on:
      - localstack
    ports:
      - "8081:8081"
    dns:
      # Set the DNS server to be the LocalStack container
      - 10.0.2.20
    networks:
      - ls

  e2e-tests:
    image: teixeirafernando/review-analysis-e2e-tests
    environment:
      - REVIEW_COLLECTOR_BASE_URL=review-collector
      - REVIEW_ANALYZER_BASE_URL=review-analyzer
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - review-collector
      - review-analyzer
    dns:
      # Set the DNS server to be the LocalStack container
      - 10.0.2.20
    networks:
      - ls
    entrypoint: [ "sh", "-c", "while ! nc -z review-collector 8080; do sleep 1; done; while ! nc -z review-analyzer 8081; do sleep 1; done; ./gradlew :e2e-tests:test" ]

networks:
  ls:
    ipam:
      config:
        # Specify the subnet range for IP address allocation
        - subnet: 10.0.2.0/24